<!DOCTYPE html>
<html>

<head>
    <title>Knock</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
</head>

<body>
    <div align="center" style="padding-top: 2rem;">
        <div style="padding: 1rem 0;">IP: <span id="ip"></span></div>
        <form id="knock-form" action="/knock" method="post" enctype="application/x-www-form-urlencoded">
            <input name="csrf-token" value="" id="knock-csrf" type="hidden"></input>
            <input name="token" value="" type="password" placeholder="auth token"></input>
            <button id="knock-button">Knock</button>
        </form>
        <div style="height: 2rem;"></div>
        <form id="flush-form" action="/knock/flush" method="post" enctype="application/x-www-form-urlencoded">
            <input name="csrf-token" value="" id="flush-csrf" type="hidden"></input>
            <input name="token" value="" type="password" placeholder="auth token"></input>
            <button id="flush-button">Flush</button>
        </form>
        <div style="height: 2rem;"></div>
        <form id="ban-form" action="/knock/ban" method="post" enctype="application/x-www-form-urlencoded">
            <input name="csrf-token" value="" id="ban-csrf" type="hidden"></input>
            <input name="token" value="" type="password" placeholder="auth token"></input>
            <input name="ips" value="" type="password" placeholder="ip list"></input>
            <button id="ban-button">Ban</button>
        </form>
    </div>
    <script>
        function getCookie(name) {
            var nameEQ = name + "=";
            var ca = document.cookie.split(';');
            for (var i = 0; i < ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0) == ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
            }
            return "";
        }
        function fixSubmitCSRF(formId, btnId, csrfId) {
            var button = document.getElementById(btnId);
            var form = document.getElementById(formId);
            button.addEventListener('click', function (event) {
                event.preventDefault();
                var csrfToken = getCookie('csrf-token');
                var csrfInput = document.getElementById(csrfId);
                csrfInput.value = csrfToken;
                form.submit();
            });
        }

        (function () {
            fixSubmitCSRF("knock-form", "knock-button", "knock-csrf");
            fixSubmitCSRF("flush-form", "flush-button", "flush-csrf");
            fixSubmitCSRF("ban-form", "ban-button", "ban-csrf");
        }());

        (function () {
            var span = document.getElementById('ip');
            fetch('/ip').then(response => {
                if (response.status != 200) {
                    throw new Error('Invalid response' + response.status);
                }
                return response.text();
            }).then(data => {
                span.innerText = data;
            }).catch(error => {
                console.error('Error:', error);
                fetch('https://api.ipify.org?format=json')
                    .then(response => {
                        if (response.status != 200) {
                            throw new Error('Invalid response' + response.status);
                        }
                        return response.json();
                    })
                    .then(data => {
                        span.innerText = data.ip;
                    }).catch(error => {
                        console.error('Error:', error);
                        span.innerText = 'unknown';
                    });
            });
        }());
    </script>
</body>

</html>